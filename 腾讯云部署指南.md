# 腾讯云部署指南 - 砸金蛋应用

## 第一步：购买腾讯云服务器

### 1. 访问腾讯云控制台

打开浏览器访问：https://cloud.tencent.com/

如果还没有账号，请先注册并完成实名认证。

### 2. 购买云服务器

进入：**产品** → **基础** → **云服务器 CVM**

点击 **新建** 或 **立即选购**

### 3. 选择配置

推荐配置（轻量应用服务器）：

| 配置项 | 推荐选择 | 说明 |
|--------|----------|------|
| **实例** | 轻量应用服务器 | 性价比高，适合Web应用 |
| **套餐** | 2核2G 或 2核4G | 2核2G足够使用 |
| **镜像** | Ubuntu 20.04 或 22.04 | 本指南基于Ubuntu编写 |
| **套餐时长** | 按需选择 | 活动用选1周/1月即可 |
| **数量** | 1台 | |

**预算参考：**
- 2核2G：约 ¥50-100/月
- 2核4G：约 ¥100-150/月
- 经常有活动价，注意优惠

### 4. 配置网络和域名

**网络配置：**
- 带宽：选择 **3Mbps** 或更高
- 网络类型：默认即可

**域名（可选）：**
- 如果需要域名访问，提前在腾讯云购买域名
- 价格：¥50-100/年（普通后缀）

### 5. 完成购买

- 确认订单并支付
- 等待服务器创建（1-5分钟）
- 创建完成后会在控制台显示

### 6. 获取登录信息

在云服务器控制台找到：

**重要信息（请保存好）：**
1. **公网IP地址**：类似 `123.456.78.90`
2. **服务器密码**：
   - 如果创建时设置了密码，使用设置的密码
   - 如果没有，点击"重置密码"设置新密码

**记录这些信息：**
- 服务器公网IP：`_____________`
- root密码：`_____________`

---

## 第二步：准备部署包（在本地电脑操作）

### 方法1：使用自动打包脚本（推荐）

在项目目录下运行：

```bash
cd E:\项目\砸金蛋
node prepare-deploy.js
```

这将自动生成 `砸金蛋-部署包.zip` 文件。

### 方法2：手动打包

1. **排除不需要的文件**

在项目根目录创建 `.deployignore` 文件：
```
node_modules/
database/*.db
database/*.db-shm
database/*.db-wal
.DS_Store
.vscode/
.git/
```

2. **打包项目**

**Windows:**
```bash
# 使用 PowerShell
Compress-Archive -Path @('public', 'database', 'server.js', 'package.json', 'package-lock.json', '部署脚本') -DestinationPath '砸金蛋-部署包.zip'
```

**或手动打包：**
- 选中以下文件/文件夹，右键压缩
  - `public/`
  - `database/` (不含.db文件)
  - `server.js`
  - `package.json`
  - `package-lock.json`
  - `部署脚本/` 文件夹

---

## 第三步：上传部署包到服务器

### 方法1：使用 WinSCP（Windows，推荐）

1. **下载 WinSCP**
   - 地址：https://winscp.net/
   - 安装并打开

2. **连接服务器**
   - 文件协议：SFTP
   - 主机名：你的服务器公网IP
   - 端口：22
   - 用户名：`root` 或 `lighthouse`
   - 密码：你的服务器密码

3. **上传文件**
   - 左侧：本地文件 → 找到 `砸金蛋-部署包.zip`
   - 右侧：服务器 → `/root/`
   - 拖拽上传

### 方法2：使用 FileZilla

1. **下载 FileZilla Client**
   - 地址：https://filezilla-project.org/

2. **连接设置**
   - 主机：`sftp://你的服务器IP`
   - 用户名：`root` 或 `lighthouse`
   - 密码：你的服务器密码
   - 端口：22

3. **上传文件**
   - 将 `砸金蛋-部署包.zip` 上传到 `/root/` 目录

### 方法3：使用命令行（高级用户）

```bash
# 在本地 PowerShell 执行
scp 砸金蛋-部署包.zip root@你的服务器IP:/root/
```

---

## 第四步：服务器端部署

### 连接到服务器

**方法1：使用 SSH 客户端**
- Windows: 下载 PuTTY 或 PowerShell
- Linux/Mac: 使用终端

**方法2：腾讯云控制台**
- 在云服务器控制台点击 **登录**
- 使用 VNC 登录或 SSH 登录

### 连接命令（SSH）

```bash
ssh root@你的服务器IP
# 输入密码后回车（密码不会显示）
```

### 部署步骤（连接服务器后执行）

#### 1. 安装 unzip（如果没有）

```bash
sudo apt update
sudo apt install unzip -y
```

#### 2. 解压部署包

```bash
cd /root
unzip 砸金蛋-部署包.zip -d lottery
cd lottery
```

#### 3. 安装 Node.js

```bash
# 安装 Node.js 18.x
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt-get install -y nodejs

# 验证安装
node -v
npm -v
```

#### 4. 安装项目依赖

```bash
npm install
```

#### 5. 运行部署脚本

```bash
chmod +x deploy.sh
./deploy.sh
```

部署脚本会自动：
- 安装 Nginx
- 配置 Nginx 反向代理
- 安装 PM2
- 启动应用
- 配置开机自启

---

## 第五步：配置域名和HTTPS（可选）

### 如果有域名

1. **域名解析**
   - 进入腾讯云 DNS 控制台
   - 添加 A 记录
   - 主机记录：`@` 或 `www`
   - 记录值：你的服务器公网IP

2. **等待DNS生效**（通常5-30分钟）

3. **配置HTTPS**

修改 Nginx 配置中的域名：
```bash
sudo nano /etc/nginx/sites-available/lottery
```

将 `你的域名或服务器IP` 改为你的实际域名。

安装 SSL 证书：
```bash
sudo apt install certbot python3-certbot-nginx
sudo certbot --nginx -d 你的域名
```

---

## 第六步：测试访问

### 1. 通过IP访问

浏览器访问：`http://你的服务器IP`

### 2. 通过域名访问（如果配置）

浏览器访问：`http://你的域名` 或 `https://你的域名`

### 3. 访问管理后台

`http://你的服务器IP/admin.html`

默认密码：`admin123`

---

## 第七步：修改安全组端口

在腾讯云控制台：

1. 进入 **云服务器 CVM** → **安全组**
2. 找到你的服务器安全组
3. 点击 **修改规则**
4. 添加入站规则：
   - 类型：自定义
   - 来源：0.0.0.0/0
   - 协议端口：TCP:80, TCP:443, TCP:3000

---

## 验证部署清单

部署完成后，请确认：

- [ ] 可以访问主页（显示金蛋）
- [ ] 可以访问管理后台
- [ ] 可以登录管理后台
- [ ] PM2 进程运行中：`pm2 list`
- [ ] Nginx 运行正常：`sudo systemctl status nginx`
- [ ] 已修改默认密码
- [ ] 已配置奖品和库存
- [ ] 测试抽奖功能正常

---

## 常用管理命令

```bash
# 查看应用状态
pm2 list

# 查看日志
pm2 logs lottery

# 重启应用
pm2 restart lottery

# 查看Nginx状态
sudo systemctl status nginx

# 重启Nginx
sudo systemctl restart nginx

# 查看Nginx错误日志
sudo tail -f /var/log/nginx/error.log
```

---

## 故障排查

### 无法访问网页

1. 检查服务状态
```bash
pm2 list
sudo systemctl status nginx
```

2. 检查安全组
- 确认端口 80 已开放

3. 查看日志
```bash
pm2 logs lottery
sudo tail -f /var/log/nginx/error.log
```

### 证书申请失败

1. 确认域名已解析
```bash
nslookup 你的域名
```

2. 确认 Nginx 配置正确
```bash
sudo nginx -t
```

3. 重试申请
```bash
sudo certbot --nginx -d 你的域名 --force-renewal
```

---

需要帮助？保存以下信息：

- 服务器IP：`_____________`
- 域名（如有）：`_____________`
- 腾讯云账号：`_____________`
